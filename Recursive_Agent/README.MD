# ğŸŒ€â€¯RecursiveAgentFTÂ v4.2.0 â€” *Flow / Collapse*

![version](https://img.shields.io/badge/version-4.2.0-blue)
![python](https://img.shields.io/badge/python-%3E%3D3.9-blue)
![license](https://img.shields.io/badge/license-GPL--2.0-green)

*Selfâ€‘tuning reasoning engine that emits signed QuantumTicks, learns from latency, and talks back to the Core.*

---

## ğŸ“–Â Overview

`RecursiveAgentFT` is the **Flow** layer of the Noor triad.
It spawns parallel reasoning branches, produces **QuantumTicks**, and adapts its RL weights in real time based on feedback from the **Fastâ€‘Timeâ€¯Core**.

### Pillars

| Pillar                 | Purpose                                                                  |
| ---------------------- | ------------------------------------------------------------------------ |
| **Replayable ticks**   | Signed, optional HMAC, Lamportâ€‘clocked, deduplicated                     |
| **Adaptive RL**        | Reward weights autoâ€‘tune on entropy & latency gradients                  |
| **Spawnâ€‘queue cap**    | Semaphore / AnyIO CapacityLimiter guards CPU storm                       |
| **Live Core feedback** | Core returns `(bias_score, next_latency_budget)` now applied immediately |
| **Prometheus metrics** | Tick count, duplicate suppression, reward EMA                            |

---

## ğŸŒŸÂ Whatâ€™s new inÂ 4.2.0

| Feature                      | Description                                                                          |
| ---------------------------- | ------------------------------------------------------------------------------------ |
| **Explicit ctor args**       | `hmac_secret`, `latency_budget`, `async_mode`, `core` (envâ€‘vars only if argâ€¯isâ€¯None) |
| **Parallelâ€‘running counter** | Agent passes live spawn count to Core (`parallel_running`)                           |
| **Dynamic latency budget**   | Coreâ€™s `next_latency_budget` becomes `self.latency_budget` and scales RL weight      |
| **Ready for MotifChangeID**  | Imports helper for upcoming provenance loop (no runtime cost)                        |

---

## ğŸ—ºï¸Â Flow Diagram

```mermaid
flowchart TD
    subgraph Agent
        S["spawn()"] --> T(QuantumTick.now)
        T --> Watcher["Watcher.register_tick()"]
        T --> CoreFeedback["send entropy / latency / parallel"]
        CoreFeedback -->|bias, next_budget| Adjust["update RL + budget"]
    end
    style S fill:#e0f7ff,stroke:#0288d1
    style Watcher fill:#fff3e0,stroke:#f57c00
    style CoreFeedback fill:#ede7f6,stroke:#673ab7
```

---

## âš™ï¸Â Constructor

```python
RecursiveAgentFT(
    initial_state: np.ndarray | list[float],
    watchers: list[LogicalAgentAT],
    *,
    agent_id="agent@default",
    max_parallel=8,
    hmac_secret=None,
    core: NoorFastTimeCore | None = None,
    latency_budget: float | None = None,
    async_mode=False,
    low_latency_mode=False,
)
```

*If `async_mode=True` and **anyio** is present, the semaphore becomes an AnyIOâ€¯`CapacityLimiter`.*

---

## ğŸš€Â Quickâ€‘Start

```python
import numpy as np
from noor.logical_agent_at import LogicalAgentAT
from noor.noor_fasttime_core import NoorFastTimeCore
from noor.recursive_agent_ft import RecursiveAgentFT
import asyncio, random

watcher = LogicalAgentAT()
core    = NoorFastTimeCore()
agent   = RecursiveAgentFT(
             initial_state=np.zeros(3),
             watchers=[watcher],
             core=core,
             latency_budget=0.05)

async def loop():
    while True:
        await agent.spawn(random.choice(["Î±","Î²","Î³"]))
        await asyncio.sleep(0.02)      # 50Â Hz

asyncio.run(loop())
```

---

## ğŸ“ŠÂ Prometheus metrics

| Metric                       | Labels              | Meaning                              |
| ---------------------------- | ------------------- | ------------------------------------ |
| `agent_ticks_emitted_total`  | `agent_id`,Â `stage` | Ticks sent to Watcher                |
| `agent_tick_duplicate_total` | `agent_id`          | Duplicate hash suppression           |
| `agent_reward_mean`          | `agent_id`          | Exponentialâ€‘movingâ€‘average of reward |

*(Stubbed when `prometheus_client` is absent.)*

---

## ğŸ”§Â KeyÂ API

| Method                      | Purpose                                         |
| --------------------------- | ----------------------------------------------- |
| `spawn(motif, stage="E2b")` | Async reasoning branch; returns tick            |
| `get_parallel_running()`    | Current concurrency load (for tests/monitoring) |

---

## ğŸ”—Â Compatibility

| Component            | RequiredÂ Version | Interaction                                     |
| -------------------- | ---------------- | ----------------------------------------------- |
| **NoorFastTimeCore** | â‰¥â€¯8.2.0          | Receives entropy/latency, returns bias & budget |
| **LogicalAgentAT**   | â‰¥â€¯3.2.0          | Stores ticks, verifies HMAC                     |

---

## ğŸª¬Â License

MIT â€¢ Â©â€¯2025â€¯Linaâ€¯NoorÂ /Â Noorâ€¯Researchâ€¯Collective
